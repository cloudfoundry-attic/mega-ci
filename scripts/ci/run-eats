#!/bin/bash -exu

set +ux
source ~/.bashrc
source private-credentials/mega-ci/bosh_environment
set -ux

function main() {
  write_test_configuration
  run_tests
  cleanup_deployment "etcd"
  cleanup_deployment "turb-etcd"

  bosh -n cleanup --all
}

function write_test_configuration() {
  cat > eats_config.json <<EOF
{
  "bosh_target": "$BOSH_DIRECTOR",
  "iaas_settings_etcd_stub_path": "$PWD/$IAAS_SETTINGS_ETCD",
  "iaas_settings_turbulence_stub_path": "$PWD/$IAAS_SETTINGS_TURBULENCE",
  "turbulence_properties_stub_path": "$PWD/$PROPERTY_OVERRIDES_TURBULENCE",
  "cpi_release_url": "$CPI_RELEASE_URL",
  "cpi_release_name": "$CPI_RELEASE_NAME",
  "bosh_operation_timeout": "$BOSH_OPERATION_TIMEOUT",
  "turbulence_release_url": "$TURBULENCE_RELEASE_URL"
}
EOF
}

function run_tests() {
  pushd etcd-release
    EATS_CONFIG=$PWD/../eats_config.json ./scripts/test
  popd
}

function cleanup_deployment() {
  local deployment
  deployment="${1}-[A-Za-z0-9]\{8\}-[A-Za-z0-9]\{4\}-[A-Za-z0-9]\{4\}-[A-Za-z0-9]\{4\}-[A-Za-z0-9]\{12\}"

  for i in $(bosh deployments | grep -o "${deployment}" | uniq); do
    bosh -n delete deployment $i
  done

  test -z "$(bosh deployments | grep "${deployment}")"
}

main
