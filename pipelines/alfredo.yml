groups:
- name: alfredo
  jobs:
  - cf-deployment-unit-tests
  - deploy-cf
  - run-smoke-tests
  - run-acceptance-tests
  - run-cats
  - bless
  - merge-master-into-develop

resources:
- name: alfredo-env
  type: git
  source:
    branch: master
    private_key: {{alfredo-env-private-key}}
    uri: git@github.com:cloudfoundry/alfredo-env.git
- name: etcd-release
  type: bosh-io-release
  source:
    repository: cloudfoundry-incubator/etcd-release
- name: consul-release
  type: bosh-io-release
  source:
    repository: cloudfoundry-incubator/consul-release
- name: mega-ci
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/mega-ci.git
- name: cf-release
  type: git
  source:
    branch: runtime-passed
    uri: https://github.com/cloudfoundry/cf-release
- name: cf-deployment-master
  type: git
  source:
    branch: master
    private_key: {{cf-deployment-private-key}}
    uri: git@github.com:cloudfoundry/cf-deployment.git
- name: cf-deployment-develop
  type: git
  source:
    branch: develop
    ignore_paths: [blessed_versions.json]
    uri: https://github.com/cloudfoundry/cf-deployment.git
- name: cf-deployment-develop-merge-target
  type: git
  source:
    branch: develop
    private_key: {{cf-deployment-private-key}}
    uri: git@github.com:cloudfoundry/cf-deployment.git
- name: aws-stemcell
  type: bosh-io-stemcell
  source:
    name: bosh-aws-xen-hvm-ubuntu-trusty-go_agent
- name: acceptance-tests-logs
  type: s3
  source:
    bucket: {{logs_bucket}}
    regexp: acceptance_tests.*.tgz
    access_key_id: {{access_key}}
    secret_access_key: {{secret_key}}
- name: cf-release-develop
  type: git
  source:
    branch: develop
    uri: https://github.com/cloudfoundry/cf-release.git

jobs:
- name: cf-deployment-unit-tests
  public: true
  plan:
  - aggregate:
    - get: cf-deployment
      resource: cf-deployment-develop
      trigger: true
    - get: mega-ci
    - get: cf-release-develop
      trigger: true
  - task: unit-tests
    file: mega-ci/scripts/ci/unit-tests-cf-deployment.yml
    config:
      params:
        CF_DEPLOYMENT_TRACE: true

- name: deploy-cf
  public: true
  serial_groups: [deploy_cf]
  plan:
  - aggregate:
    - get: private-credentials
      resource: alfredo-env
    - get: mega-ci
    - get: cf-release
      trigger: true
    - get: etcd-release
      trigger: true
    - get: cf-deployment
      resource: cf-deployment-develop
      trigger: true
      passed: [cf-deployment-unit-tests]
    - get: stemcell
      resource: aws-stemcell
      trigger: true
    - get: consul-release
      trigger: true
  - task: deploy-cf
    file: mega-ci/scripts/ci/deploy-cf-alone/task.yml
    config:
      params:
        STUB_PATH: {{cf_stub_path}}
        STUB_PARTS_PATH: {{cf_stub_parts_path}}
        BOSH_DIRECTOR: {{cf_bosh_director}}
        BOSH_USER: {{cf_bosh_user}}
        BOSH_PASSWORD: {{cf_bosh_password}}
        CF_DEPLOYMENT_TRACE: true
  - task: cleanup
    file: mega-ci/scripts/ci/run-bosh-command.yml
    config:
      params:
        DEPLOYMENT_NAME: cf-alfredo
        COMMAND: cleanup
        ENVIRONMENT: alfredo

- name: run-smoke-tests
  public: true
  serial_groups: [deploy_cf]
  plan:
  - aggregate:
    - get: private-credentials
      resource: alfredo-env
    - get: mega-ci
    - get: cf-release
      passed: [deploy-cf]
      trigger: true
    - get: etcd-release
      trigger: true
      passed: [deploy-cf]
    - get: cf-deployment
      resource: cf-deployment-develop
      passed: [deploy-cf]
      trigger: true
    - get: stemcell
      resource: aws-stemcell
      passed: [deploy-cf]
      trigger: true
    - get: consul-release
      passed: [deploy-cf]
      trigger: true
  - task: smoke-tests
    file: mega-ci/scripts/ci/run-bosh-command.yml
    config:
      params:
        COMMAND: 'run errand smoke_tests'
        DEPLOYMENT_NAME: cf-alfredo
        ENVIRONMENT: alfredo

- name: run-acceptance-tests
  public: true
  serial_groups: [deploy_cf]
  plan:
  - aggregate:
    - get: private-credentials
      resource: alfredo-env
    - get: mega-ci
    - get: cf-release
      passed: [run-smoke-tests]
      trigger: true
    - get: etcd-release
      passed: [run-smoke-tests]
      trigger: true
    - get: cf-deployment
      resource: cf-deployment-develop
      passed: [run-smoke-tests]
      trigger: true
    - get: stemcell
      resource: aws-stemcell
      passed: [run-smoke-tests]
      trigger: true
    - get: consul-release
      passed: [run-smoke-tests]
      trigger: true
  - task: acceptance-tests
    file: mega-ci/scripts/ci/run-cats-errand/task.yml
    config:
      params:
        DEPLOYMENT_NAME: cf-alfredo
        ENVIRONMENT: alfredo
    ensure:
      put: acceptance-tests-logs
      params:
        from: logs-dir/acceptance_tests(.*).tgz

- name: run-cats
  public: true
  serial_groups: [deploy_cf]
  plan:
  - aggregate:
    - get: mega-ci
    - get: cf-release
      passed: [run-smoke-tests]
      trigger: true
    - get: etcd-release
      passed: [run-smoke-tests]
      trigger: true
    - get: cf-deployment
      resource: cf-deployment-develop
      passed: [run-smoke-tests]
      trigger: true
    - get: stemcell
      resource: aws-stemcell
      passed: [run-smoke-tests]
      trigger: true
    - get: consul-release
      passed: [run-smoke-tests]
      trigger: true
  - aggregate:
    - task: everything-else
      file: mega-ci/scripts/ci/run-cats/task.yml
      config:
        params:
          CF_API: {{alfredo-cf-api}}
          CF_ADMIN_PASSWORD: {{alfredo-cf-admin-password}}
          CF_APPS_DOMAIN: {{alfredo-cf-apps-domain}}
          SKIP_SSL_VALIDATION: true
          NODES: 8
          SUITES: "apps assets detect docker internet_dependent operator routing"
          ADDITIONAL_ARGS: "-skip=NO_DEA_SUPPORT -slowSpecThreshold=240 -keepGoing -failOnPending"
    - task: services-security_groups-ssh
      file: mega-ci/scripts/ci/run-cats/task.yml
      config:
        params:
          CF_API: {{alfredo-cf-api}}
          CF_ADMIN_PASSWORD: {{alfredo-cf-admin-password}}
          CF_APPS_DOMAIN: {{alfredo-cf-apps-domain}}
          NODES: 8
          SKIP_SSL_VALIDATION: true
          SUITES: "services security_groups ssh"
          ADDITIONAL_ARGS: "-skip=NO_DEA_SUPPORT -slowSpecThreshold=240 -keepGoing -failOnPending"

- name: bless
  public: true
  serial: true
  plan:
  - aggregate:
    - get: mega-ci
    - get: cf-release
      passed: [run-acceptance-tests]
      trigger: true
    - get: etcd-release
      passed: [run-acceptance-tests]
      trigger: true
    - get: release-repo
      resource: cf-deployment-develop
      passed: [run-acceptance-tests]
      trigger: true
    - get: release-repo-master
      resource: cf-deployment-master
    - get: stemcell
      resource: aws-stemcell
      passed: [run-acceptance-tests]
      trigger: true
    - get: consul-release
      passed: [run-acceptance-tests]
      trigger: true
  - task: commit-blessing
    file: mega-ci/scripts/ci/commit-blessing.yml
  - put: cf-deployment-master
    params:
      repository: commit-blessing/release-repo
- name: merge-master-into-develop
  public: true
  serial: true
  plan:
  - aggregate:
    - get: mega-ci
    - get: release-repo-master
      resource: cf-deployment-master
      trigger: true
    - get: release-repo
      resource: cf-deployment-develop-merge-target
      params: {fetch: [master]}
  - task: merge-master-into-develop
    file: mega-ci/scripts/ci/merge-master-into-develop.yml
  - put: cf-deployment-develop-merge-target
    params:
      repository: merge-master-into-develop/release-repo
