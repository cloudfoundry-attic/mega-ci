#Creating a Cloud Foundry Deployment Stub

##Choosing an example stub

If you are creating a deployment that needs the ability to redeploy without any downtime,
you should start with `multi_az.yml`.

If you are creating a development or test deployment, `single_az.yml` will be faster
to deploy, and use fewer resources.

###Adding Cloud Front CDN
 
If you configured Cloud Front when configuring your AWS deployment, you can include the `cloud_front.yml`
when merging your templates. This will configure the Resources and Droplet blobstores to use Cloud Front.
Most deployments will not need a CDN for their blobstores.

##Filling out the template

###Deployment Name

Replace `REPLACE_WITH_DEPLOYMENT_NAME` with the name you want your bosh deployment to have.

###Usernames and Passwords

`REPLACE_WITH_USERNAME` and `REPLACE_WITH_PASSWORD` should be replaced with usernames and passwords.
These are not credentials used by users, but rather values that are used while various components
are authenticating to each other.

###Admin Password
The `REPLACE_WITH_ADMIN_USER_PASSWORD` value should be replaced with the password for the admin user.
This account has full access by default and should be kept secure.

###UAA Signing Keys

UAA needs an RSA keypair for creating tokens.
Run the following commands:    
`openssl genrsa -out private.pem 2048`    
`openssl rsa -pubout -in private.pem -out public.pem`

Replace `REPLACE_WITH_RSA_PRIVATE_KEY` with the contents of `private.pem`.    
Replace `REPLACE_WITH_RSA_PUBLIC_KEY` with the contents of `public.pem`.

###Consul Keys and Certificates

Consul needs a 16bit base64 encoded encryption key. 

Run `cat /dev/urandom | head -c 16 | base64` and replace `REPLACE_WITH_CONSUL_ENCRYPTION_KEY` with the output.

Checkout [cf-release][cf-release] and run `cf-release/scripts/generate-consul-certs`. This will create a consul-certs
directory.

Replace `REPLACE_WITH_CONSUL_CA_CERT` with the contents of `consul-certs/server-ca.crt`    
Replace `REPLACE_WITH_CONSUL_SERVER_CERT` with the contents of `consul-certs/server.crt`
Replace `REPLACE_WITH_CONSUL_SERVER_KEY` with the contents of `consul-certs/server.key`
Replace `REPLACE_WITH_CONSUL_AGENT_CERT` with the contents of `consul-certs/agent.crt`
Replace `REPLACE_WITH_CONSUL_AGENT_KEY` with the contents of `consul-certs/agent.key`

###Self Signed SSL Certificate

If the certificate you provided for use on the ELB is a self signed cert. Change the following
properties to `true`.

`properties.ssl.skip_cert_verify`    
`properties.acceptance_tests.skip_ssl_validation`    
`properties.smoke_tests.skip_ssl_validation`

##Merging the stubs
These stubs depend on artifacts generated by the `scripts/deploy_cf_bosh_instance` script. That script was
run with a DEPLOYMENT_DIRECTORY and the artifacts should be in there.

Merging your stubs to create a deployment manifest using `cf-release`:    
`./scripts/generate_deployment_manifest aws PATH_TO_YOUR_STUB DEPLOYMENT_DIRECTORY/generated-stubs/cf/*`

Deploying with your stubs using `cf-deployment`:    
`./scripts/deploy aws PATH_TO_CF_RELEASE PATH_TO_ETCD_RELEASE PATH_TO_YOUR_STUB DEPLOYMENT_DIRECTORY/generated-stubs/cf/*`

[cf-release]: https://github.com/cloudfoundry/cf-release